<?xml version="1.0" encoding="UTF-8"?>

<!-- RULES 
    * A live cell dies if it has fewer than 2 neighbors
    * A live cell with two or three live neighbors lives on
    * A live cell with more than three live neighbors dies
    * A dead cell will be brought back to live if it has 3 neighbors
-->

<Graphs xmlns="" appname="gol">
    <GraphType id="gol_type">
        <Properties>
            <![CDATA[ 
            uint8_t cellCount = 5;
            uint8_t maxGeneration = 10;
            ]]>
        </Properties>
        <MessageTypes>
            <MessageType id="ping">
                <Message>
                    <![CDATA[ 
                    bool alive;
                    uint32_t generation;
                    bool done;
                    ]]>
                </Message>
            </MessageType>
        </MessageTypes>
        <DeviceTypes>
            <DeviceType id="cell">
                <Properties>
                    <![CDATA[ 
                    bool alive;
                    ]]>
                </Properties>
                <State>
                    <![CDATA[ 
                    bool alive;
                    bool done = false;
                    uint32_t generation = 0;

                    uint8_t conversations[2] = {0, 0};
                    uint8_t livingNeighbours[2] = {0, 0};
                    ]]>
                </State>
                <OnInit>
                    <![CDATA[ 
                    DEVICESTATE(alive) = DEVICEPROPERTIES(alive);
                    DEVICESTATE(generation) = GRAPHPROPERTIES(maxGeneration);
                    ]]>
                </OnInit>
                <ReadyToSend>
                    <![CDATA[ 
                    if (DEVICESTATE(generation) <= GRAPHPROPERTIES(maxGeneration)) {
                        if (DEVICESTATE(conversations[DEVICESTATE(generation) % 2]) >= 2) {
                            RTSSUP():
                            RTS(sender);
                        }
                    }
                    ]]>
                </ReadyToSend>
                <OutputPin name="sender" messageTypeId="ping">
                    <OnSend>
                        <![CDATA[    
                        uint8_t cycle = DEVICESTATE(generation) % 2;

                        if (DEVICESTATE(alive)) {
                            if (DEVICESTATE(livingNeighbours[cycle]) < 1) DEVICESTATE(alive) = false;
                        }
                        else {
                            if (DEVICESTATE(livingNeighbours[cycle]) > 1) DEVICESTATE(alive) = true;
                        }

                        DEVICESTATE(generation) ++;
                        DEVICESTATE(conversations[cycle]) = 0;
                        DEVICESTATE(livingNeighbours[cycle]) = 0;
                        if (DEVICESTATE(generation) >= GRAPHPROPERTIES(maxGeneration)) DEVICESTATE(done) = true;
                        
                        MSG(alive) = DEVICESTATE(alive);
                        MSG(generation) = DEVICESTATE(generation);
                        MSG(done) = DEVICESTATE(done);
                        ]]>
                    </OnSend>
                </OutputPin>
                <InputPin name="receiver" messageTypeId="ping">
                    <OnReceive>
                        <![CDATA[
                        DEVICESTATE(conversations[MSG(generation) % 2]) ++;
                        DEVICESTATE(livingNeighbours[MSG(generation) % 2]) += MSG(alive);
                        ]]>
                    </OnReceive>
                </InputPin>
            </DeviceType>
            <SupervisorType id="id">
                <Code>
                    <![CDATA[ 
                    #include <stdio.h>
                    ]]>
                </Code>
                <State>
                    <![CDATA[
                    bool failed = false;
                    bool finished = false;
    
                    int finishedCells = 0;
    
                    FILE* resultFile;
                    ]]>
                </State>
                <OnInit>
                    <![CDATA[ 
                    Super::post("onInit ====================");
                    SUPSTATE(resultFile) = fopen("gol_output", "w");
                    ]]>
                </OnInit>
                <OnStop>
                    <![CDATA[
                    Super::post("onStop ====================");
                    fclose(SUPSTATE(resultFile));
                    ]]>
                </OnStop>
                <SupervisorInPin id="" messageTypeId="ping">
                    <OnReceive>
                        <![CDATA[ 
                        Super::post("onReceive ====================");
                        if (!SUPSTATE(failed))
                        {
                            if (MSG(done)) {
                                SUPSTATE(finishedCells) ++;
    
                                if (SUPSTATE(finishedCells) >= GRAPHPROPERTIES(cellCount)) {
                                    SUPSTATE(finished) = true;
                                    fprintf(SUPSTATE(resultFile), "1"); 
                                }
                            }
                        }
                        ]]>
                    </OnReceive>
                </SupervisorInPin>
            </SupervisorType>
        </DeviceTypes>
    </GraphType>

    <GraphInstance id="gol_instance" graphTypeId="gol_type" P="{5,10}">
        <DeviceInstances>
            <DevI id="0" type="cell" P="{0}" />
            <DevI id="1" type="cell" P="{1}" />
            <DevI id="2" type="cell" P="{0}" />
            <DevI id="3" type="cell" P="{1}" />
            <DevI id="4" type="cell" P="{0}" />
        </DeviceInstances>
        <EdgeInstances>
            <EdgeI path="1:receiver-0:sender" />
            <EdgeI path="2:receiver-1:sender" />
            <EdgeI path="3:receiver-2:sender" />
            <EdgeI path="4:receiver-3:sender" />
            <EdgeI path="0:receiver-4:sender" />
        </EdgeInstances>
    </GraphInstance>
</Graphs>